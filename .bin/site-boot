# #!/bin/zsh
common_dir="/Users/zooey/Documents/code/javascript/common"
site_dir="/Users/zooey/Documents/code/site"

# Creates & sets up the tmux session
tmux new-session -d -c $site_dir -P -ssite -nmain_loop

# This will be our main server/loop pane.
tmux split-window -tsite
# Split will default to horizontal split.
#    " is a horizontal split (e.g. the window is split along the horizon.)
#    % is a vertical split (the window is split along the vertical.)

# todo: possible to get size of window and have it as a percentage?
tmux resize-pane -D 50

# Startup postgres
tmux send-keys -tsite "pg_ctl -l $PGDATA/logfile.log start" Enter
# Startup webpackDevServer
tmux send-keys -tsite "cd $site_dir/frontend/; npm run start" Enter
tmux split-window -htsite

# Update on save
tmux send-keys -tsite "cd $common_dir; find * | entr -s ./update-downstream-on-save.sh" Enter
# Update on commit
# tmux send-keys -tsite "echo .git/COMMIT_EDITMSG | entr -s ./update-downstream.sh" Enter
tmux resize-pane -R 30
tmux selectp -U

tmux send-keys -tsite "cd ~/Documents/code/site/server/; clear; sudo node src/server.js" Enter

startup_exec="$site_dir/startup_exec"
echo "moveto -x 0 -y 0; resize -x 120 -y 40; tmux attach-session -tsite;" > startup_exec
chmod +x startup_exec
open -a \
     /System/Applications/Utilities/Terminal.app \
     --fresh --new \
     startup_exec;

exit;
